
<style>
    * {
        box-sizing: border-box !important;
    }

    body {
        font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        line-height: 1.9 !important;
        color: #1f1f1f !important;
        max-width: none !important;
        margin: 0 !important;
        padding: 8px 16px 16px 16px !important;
        background: #ffffff !important;
        font-size: 16.5px !important;
    }

    p {
        margin-bottom: 20px !important;
        font-size: 16.5px !important;
        line-height: 1.95 !important;
        color: #1f1f1f !important;
        font-weight: 400 !important;
    }

    strong, b {
        color: #1a73e8 !important;
        font-weight: 700 !important;
        background: rgba(26, 115, 232, 0.08) !important;
        padding: 2px 6px !important;
        border-radius: 8px !important;
    }

    /* Details/Summary (collapsible sections) */
    details {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
        border-radius: 8px !important;
        padding: 24px 28px !important;
        margin: 24px 0 !important;
        border: none;
        box-shadow: none !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    details:hover {
        border-color: #1a73e8 !important;
        box-shadow: none !important;
        transform: translateY(-2px) !important;
    }

    details[open] {
        background: #ffffff !important;
        border-color: #1a73e8 !important;
        box-shadow: none !important;
    }

    summary {
        cursor: pointer !important;
        font-weight: 800 !important;
        color: #ffffff !important;
        font-size: 20px !important;
        padding: 16px 24px !important;
        border-radius: 8px !important;
        background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        user-select: none !important;
        box-shadow: none !important;
        letter-spacing: 0.5px !important;
    }

    summary:hover {
        background: linear-gradient(135deg, #1557b0 0%, #0d47a1 100%) !important;
        transform: translateX(6px) scale(1.02) !important;
        box-shadow: none !important;
    }

    summary:active {
        transform: translateX(4px) scale(0.99) !important;
    }

    summary::marker {
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 1.3em !important;
    }

    summary strong {
        background: rgba(255, 255, 255, 0.2) !important;
        color: #ffffff !important;
        padding: 4px 12px !important;
        border-radius: 8px !important;
        margin-left: 8px !important;
        font-size: 19px !important;
        letter-spacing: 1px !important;
    }

    /* Tables - Premium Design */
    table {
        width: 100% !important;
        border-collapse: separate !important;
        border-spacing: 0 !important;
        margin: 28px 0 !important;
        border-radius: 8px !important;
        overflow: hidden !important;
        box-shadow: none !important;
        border: none !important;
        background: #ffffff !important;
    }

    table.simple-table {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
    }

    table tr {
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
        position: relative !important;
    }

    table tr:nth-child(odd) {
        background: rgba(248, 249, 250, 0.5) !important;
    }

    table tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.8) !important;
    }

    table tr:hover {
        background: linear-gradient(90deg, #e8f0fe 0%, #f1f8ff 100%) !important;
        transform: translateX(4px) scale(1.01) !important;
        box-shadow: none !important;
        z-index: 1 !important;
    }

    table td {
        padding: 18px 24px !important;
        border-bottom: 1px solid rgba(232, 234, 237, 0.6) !important;
        font-size: 16.5px !important;
        line-height: 1.7 !important;
        color: #1f1f1f !important;
        vertical-align: middle !important;
    }

    table tr:last-child td {
        border-bottom: none !important;
    }

    /* First column (A, B, C, D, E) */
    table td:first-child {
        font-weight: 800 !important;
        color: #ffffff !important;
        width: 52px !important;
        text-align: center !important;
        font-size: 18px !important;
        background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%) !important;
        border-right: 3px solid #1557b0 !important;
        position: relative !important;
        letter-spacing: 0.5px !important;
    }

    table tr:hover td:first-child {
        background: linear-gradient(135deg, #1557b0 0%, #0d47a1 100%) !important;
        box-shadow: none !important;
    }

    /* Second column (content) */
    table td:nth-child(2) {
        font-weight: 500 !important;
        padding-left: 28px !important;
    }

    /* Third column (empty - hide it) */
    table td:last-child:empty {
        display: none !important;
    }

    /* Lists */
    ul, ol {
        margin: 16px 0 !important;
        padding-left: 32px !important;
    }

    li {
        margin: 10px 0 !important;
        line-height: 1.8 !important;
        color: #1f1f1f !important;
    }

    ul.bulleted-list li {
        position: relative !important;
        padding-left: 8px !important;
    }

    ul.toggle {
        list-style: none !important;
        padding-left: 0 !important;
    }

    /* Links */
    a {
        color: #1a73e8 !important;
        text-decoration: none !important;
        font-weight: 600 !important;
        border-bottom: 2px solid transparent !important;
        transition: all 0.2s !important;
    }

    a:hover {
        border-bottom-color: #1a73e8 !important;
        background: rgba(26,115,232,0.08) !important;
        padding: 2px 4px !important;
        border-radius: 8px !important;
    }

    /* Images & Media */
    img, video {
        max-width: none !important;
        height: auto !important;
        border-radius: 8px !important;
        box-shadow: none !important;
        margin: 24px 0 !important;
        display: block !important;
        border: none !important;
    }

    img:hover, video:hover {
        box-shadow: none !important;
        border-color: #1a73e8 !important;
    }

    /* Code blocks (if any) */
    code {
        background: #f1f3f4 !important;
        padding: 2px 8px !important;
        border-radius: 8px !important;
        font-family: 'Courier New', monospace !important;
        font-size: 14px !important;
        color: #d93025 !important;
    }

    pre {
        background: #f8f9fa !important;
        padding: 8px 16px 16px 16px !important;
        border-radius: 8px !important;
        overflow-x: auto !important;
        border-left: 4px solid #1a73e8 !important;
    }

    /* Headings */
    h1, h2, h3, h4, h5, h6 {
        color: #1a73e8 !important;
        font-weight: 700 !important;
        margin-top: 24px !important;
        margin-bottom: 16px !important;
        line-height: 1.4 !important;
    }

    h1 { font-size: 32px !important; }
    h2 { font-size: 26px !important; }
    h3 { font-size: 22px !important; }
    h4 { font-size: 19px !important; }

    /* Blockquotes */
    blockquote {
        border-left: 4px solid #1a73e8 !important;
        padding-left: 20px !important;
        margin: 20px 0 !important;
        font-style: italic !important;
        color: #5f6368 !important;
        background: #f8f9fa !important;
        padding: 16px 20px !important;
        border-radius: 8px !important;
    }

    /* Horizontal Rule */
    hr {
        border: none !important;
        height: 2px !important;
        background: linear-gradient(to right, transparent, #1a73e8, transparent) !important;
        margin: 32px 0 !important;
    }

    /* Selection */
    ::selection {
        background: #e8f0fe !important;
        color: #1a73e8 !important;
    }

    /* Highlighter styles */
    .highlighted {
        background-color: #ffeb3b !important;
        transition: background-color 0.2s ease !important;
    }

    .highlighter-btn {
        background: none !important;
        border: none !important;
        cursor: pointer !important;
        font-size: 20px !important;
        padding: 0 8px !important;
        margin-left: 8px !important;
        transition: transform 0.2s ease !important;
        vertical-align: middle !important;
    }

    .highlighter-btn:hover {
        transform: scale(1.2) !important;
    }

    .highlighter-btn.active {
        transform: scale(1.1) !important;
        filter: brightness(1.2) !important;
    }

    .highlighter-mode-active {
        cursor: text !important;
    }


    /* Right padding to avoid overlap with sidebar buttons */
    body {
        padding-right: 50px !important;
    }

    @media (max-width: 768px) {
        body {
            padding-right: 16px !important;
        }
    }

</style>




<details open>
<summary><strong>1535</strong><button class="bionic-reading-btn" onclick="toggleBionicReading(event)" title="Toggle Bionic Reading (Ctrl+B)"><span id="bionicIcon">üëÅÔ∏è</span></button><button class="highlighter-btn" onclick="toggleHighlighter(event)" title="Toggle Highlighter (Ctrl+H)"><span id="highlighterIcon">üñäÔ∏è</span></button></summary>
<p class="" id="a1531ab9-4291-4c3e-bd69-194e5068615e">A 35-year-old previously
                                        healthy woman comes to the hospital due to several days of productive cough
                                        associated with chills and fever.  Her sputum is purulent with faint pink
                                        streaks of blood.  The patient also has sharp pain over the right shoulder and
                                        neck area brought on by deep inspiration.  Past medical history is
                                        unremarkable.  Her temperature is 38.3 C (101 F), blood pressure is 130/70 mm
                                        Hg, pulse is 98/min, and respirations are 22/min.  Examination reveals crackles
                                        and dullness over the right lower pulmonary lobe.  While listening with the
                                        stethoscope over the right midback, the examiner has the patient say the letter
                                        "E," and the sound is perceived by the examiner as a loud letter
                                        "A."  A chest x-ray is obtained and is shown in the image below.</p>
<figure class="image" id="cdc377e8-8bb4-4d31-a466-382f6e1bb13d"><a href="https://lh7-us.googleusercontent.com/mfJUgL4IBnIUMgORRl6OAik5HN44FN0Qwvp7gBTm-WGG4Ozn6rUCeX_m9cvDpN_75Zk6ouI03LIb2gLUswkf6c-kd2eexhyMgIpNAcs6PR8onfumLLD-CL-0vh0NRjSqOL-8CNDCnNDhbZMshoZobE0"><img loading="lazy" src="https://lh7-us.googleusercontent.com/mfJUgL4IBnIUMgORRl6OAik5HN44FN0Qwvp7gBTm-WGG4Ozn6rUCeX_m9cvDpN_75Zk6ouI03LIb2gLUswkf6c-kd2eexhyMgIpNAcs6PR8onfumLLD-CL-0vh0NRjSqOL-8CNDCnNDhbZMshoZobE0" style="width:509px"/></a>
</figure>
<p class="" id="ca420f87-ca4b-405b-ac8a-df1f3086f4f6">The pain experienced by this
                                        patient is most likely carried by which of the following nerves?</p>
<table class="simple-table" id="d71d86b7-c558-40e0-987e-97845e64b67d">
<tbody>
<tr id="3bba7079-1d9d-4e0a-8d47-f8f08204ed43">
<td class="" id="lRHk">A.</td>
<td class="" id=":Pnr">Accessory</td>
<td class="" id="Ncbx"></td>
</tr>
<tr id="0523efe8-b1f6-4782-a3c4-5cced4fa932e">
<td class="" id="lRHk">B.</td>
<td class="" id=":Pnr">Intercostal</td>
<td class="" id="Ncbx"></td>
</tr>
<tr id="b238cfc7-c4ab-4e4a-aff3-46eb798d7919">
<td class="" id="lRHk">C.</td>
<td class="" id=":Pnr">Long thoracic</td>
<td class="" id="Ncbx"></td>
</tr>
<tr id="6e3c2557-f8eb-4d4f-8236-ff1c5b65bd18">
<td class="" id="lRHk">D.</td>
<td class="" id=":Pnr">Phrenic</td>
<td class="" id="Ncbx"></td>
</tr>
<tr id="33495eea-9390-442c-9e90-8223dd0f88d7">
<td class="" id="lRHk">E.</td>
<td class="" id=":Pnr">Vagus</td>
<td class="" id="Ncbx"></td>
</tr>
</tbody>
</table>
<ul class="toggle" id="ad10a3f6-1d50-4c49-a7b0-a69fcf639d26">
<li>
<details>
<summary>Submit</summary>
<table class="simple-table" id="3f6f023b-0560-4fe3-a6a0-f1393e6c1be9">
<tbody>
<tr id="8a2ec663-198a-4c55-9f42-97cf45981d0d">
<td class="" id="{H=U">A.</td>
<td class="" id="m&gt;rj">Accessory (4%)</td>
<td class="" id="c=qQ"></td>
</tr>
<tr id="0ce669f8-1c7e-4b1b-8fc3-61d1f00146c8">
<td class="" id="{H=U">B.</td>
<td class="" id="m&gt;rj">Intercostal (5%)</td>
<td class="" id="c=qQ"></td>
</tr>
<tr id="7e11b722-c7f8-4671-b857-ad2de79ff7f4">
<td class="" id="{H=U">C.</td>
<td class="" id="m&gt;rj">Long thoracic (4%)</td>
<td class="" id="c=qQ"></td>
</tr>
<tr id="e70ab737-d297-4d91-8920-4abf4ed1d377">
<td class="" id="{H=U">D.</td>
<td class="" id="m&gt;rj">Phrenic (81%)</td>
<td class="" id="c=qQ"></td>
</tr>
<tr id="3b55f500-0169-456f-9773-d630442ef6c5">
<td class="" id="{H=U">E.</td>
<td class="" id="m&gt;rj">Vagus (4%)</td>
<td class="" id="c=qQ"></td>
</tr>
</tbody>
</table>
<p class="" id="420dd191-30d1-4642-8fda-f2d58966e3e8">Incorrect</p>
<p class="" id="1022cf94-f334-403b-b211-895a29feffaa">Correct answer D
                                                </p>
<p class="" id="bdc42ed5-f621-4730-ae4a-9db902fc483b">81%Answered
                                                    correctly</p>
<p class="" id="975f8867-a0d8-4c00-83d2-d462466888af">17 secsTime Spent
                                                </p>
<p class="" id="6956e467-a254-4843-8566-7aee4cc4b187">2024Version</p>
<ul class="bulleted-list" id="6a846520-bd05-40f9-ba36-69706e47bc35">
<li style="list-style-type:disc">Explanation</li>
</ul>
<ul class="bulleted-list" id="ff8c33bb-a00a-4f73-99e9-eaa6eafd930b">
<li style="list-style-type:disc"></li>
</ul>
<p class="" id="ba3902e5-d388-4a4c-8120-ec8608785b5d">This patient is
                                                    experiencing pleuritic chest pain due to acute lower lobe bacterial
                                                    pneumonia.  Pleuritic chest pain is characterized by sharp,
                                                    localized, often severe pain that is exacerbated by coughing,
                                                    breathing, or changing position.  It can result from any condition
                                                    that causes inflammation of the pleura (eg, infection, pulmonary
                                                    embolism, uremia).  The pleura are divided into segments as follows:
                                                </p>
<p class="" id="980e6766-0be2-4dfb-a123-375109feac8f">Visceral pleura:
                                                    The visceral (pulmonary) pleura covers all surfaces of the lungs,
                                                    including the surfaces within the pulmonary fissures.  The visceral
                                                    pleura does not carry pain fibers.</p>
<p class="" id="48f970eb-a613-47c8-8c4b-8c0cbb38b493">Parietal pleura:
                                                    The parietal pleura forms the outer boundary of the pleural space
                                                    and can be subdivided as follows:</p>
<ul class="bulleted-list" id="564fa40a-a169-474a-996b-bf645ea2940a">
<li style="list-style-type:disc">Costal pleura: Covers the thoracic
                                                        wall, including the ribs, sternum, intercostal spaces, costal
                                                        cartilages, and sides of the thoracic vertebrae</li>
</ul>
<ul class="bulleted-list" id="1944bc74-c7c1-41ef-a4cf-880c81ffd18b">
<li style="list-style-type:disc">Mediastinal pleura: Covers the
                                                        mediastinum</li>
</ul>
<ul class="bulleted-list" id="f58c8606-7cec-475c-9120-819f55a3862a">
<li style="list-style-type:disc">Diaphragmatic pleura: Covers the
                                                        surface of the diaphragm located within the thoracic cavity</li>
</ul>
<ul class="bulleted-list" id="8471ac5f-cf29-4b06-8b89-0b0903a5b792">
<li style="list-style-type:disc">Cervical pleura: Extends with the
                                                        apices of the lung into the neck</li>
</ul>
<p class="" id="cc74800c-5218-476e-be9f-401101e90cb3">The phrenic nerve,
                                                    which is derived from the C3-C5 nerve roots, delivers motor
                                                    innervation to the diaphragm and carries pain fibers from the
                                                    diaphragmatic and mediastinal pleura.  Irritation of the pleura in
                                                    either area will cause a sharp pain worsened by inspiration that
                                                    will be referred to the C3-C5 distribution at the base of the neck
                                                    and over the shoulder.  Sensory innervation of the remainder of the
                                                    parietal pleura is accomplished by intercostal nerves and is
                                                    typically felt closer to the source of the pain (Choice B).</p>
<p class="" id="10f99778-2765-473c-b8b9-ed3e5647a958">(Choice A)  The
                                                    spinal accessory nerve (cranial nerve XI) provides motor innervation
                                                    to the sternocleidomastoid and trapezius muscles.</p>
<p class="" id="0cbd6e09-849f-4a88-b28f-6ecc2a88f2b2">(Choice C)  The
                                                    long thoracic nerve innervates the serratus anterior.  Damage to
                                                    this nerve causes a winged scapula.</p>
<p class="" id="aa6755a9-fd1e-4407-9288-433abdf02dae">(Choice E)  The
                                                    vagus nerve (cranial nerve X) is the major source of parasympathetic
                                                    innervation to the viscera of the chest and the foregut.</p>
<p class="" id="74bcbb70-6639-4df3-97eb-167eadcb28fb">Educational
                                                    objective:</p>
<p class="" id="790a81d9-4f8d-45cc-9b15-1e10418d8cae">Irritation of the
                                                    parietal pleura will cause sharp pain, which is worse on
                                                    inspiration.  Pain arising from the mediastinal or diaphragmatic
                                                    pleura will be carried by the phrenic nerve and referred to the
                                                    C3-C5 distribution.</p>
<p class="" id="8da0675f-3fc8-4e46-9645-55400d6204fd">Anatomy</p>
<p class="" id="7d3235ce-eeae-4a24-8830-a0a21e1b9c15">Subject</p>
<p class="" id="51d14a4f-8ab6-4613-8481-806d5f4a5e5a">Pulmonary &amp;
                                                    Critical Care</p>
<p class="" id="3e70a9ac-0ce6-4dd2-82b0-d6ee0ce4a65f">System</p>
<p class="" id="fef6e315-7f2c-4a16-8ff2-591413cfd1a6">Community acquired
                                                    pneumonia</p>
<p class="" id="ac85cb08-d49e-4776-9fbd-9de854651c10">Topic</p>
<p class="" id="521fa080-54aa-4523-8e6e-7d9217dd5162">Copyright ¬©
                                                    UWorld. All rights reserved.</p>
<p class="" id="47225fbc-5745-4003-821a-6922e2eed3e5">‚ùåelementFinder:
                                                    //a[@href='javascript:void(0)']</p>
</details>
</li>
</ul>
</details>


















<style>
.bionic-reading-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s;
    margin-left: auto;
    flex-shrink: 0;
}

.bionic-reading-btn:hover {
    background: rgba(255, 255, 255, 0.35);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
}

.bionic-reading-btn.active {
    background: rgba(52, 168, 83, 0.4);
    border-color: rgba(52, 168, 83, 0.6);
}

.bionic-reading-btn.active:hover {
    background: rgba(52, 168, 83, 0.5);
}

summary {
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
}

    /* Highlighter styles */
    .highlighted {
        background-color: #ffeb3b !important;
        transition: background-color 0.2s ease !important;
    }

    .highlighter-btn {
        background: none !important;
        border: none !important;
        cursor: pointer !important;
        font-size: 20px !important;
        padding: 0 8px !important;
        margin-left: 8px !important;
        transition: transform 0.2s ease !important;
        vertical-align: middle !important;
    }

    .highlighter-btn:hover {
        transform: scale(1.2) !important;
    }

    .highlighter-btn.active {
        transform: scale(1.1) !important;
        filter: brightness(1.2) !important;
    }

    .highlighter-mode-active {
        cursor: text !important;
    }


    /* Right padding to avoid overlap with sidebar buttons */
    body {
        padding-right: 50px !important;
    }

    @media (max-width: 768px) {
        body {
            padding-right: 16px !important;
        }
    }

</style>



<script>
let bionicEnabled = false;
const originalContent = {};

function toggleBionicReading(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    bionicEnabled = !bionicEnabled;
    const btn = document.querySelector('.bionic-reading-btn');
    const icon = document.getElementById('bionicIcon');

    if (bionicEnabled) {
        btn.classList.add('active');
        icon.textContent = '‚úÖ';
        applyBionicReading();
    } else {
        btn.classList.remove('active');
        icon.textContent = 'üëÅÔ∏è';
        restoreOriginalText();
    }
}

function applyBionicReading() {
    // Seleciona todos os elementos de texto, EXCETO summary e buttons
    const textElements = document.querySelectorAll('p:not(summary p):not(button p), td:not(summary td):not(button td), li:not(summary li):not(button li)');

    textElements.forEach((element, index) => {
        // Ignora elementos que cont√™m outros elementos complexos
        if (element.querySelector('p, td, li, h1, h2, h3, h4, h5, h6, button, summary')) {
            return;
        }

        // Ignora se o elemento est√° dentro de um summary ou button
        if (element.closest('summary') || element.closest('button') || element.closest('.bionic-reading-btn')) {
            return;
        }

        // Salva o conte√∫do original
        if (!originalContent[index]) {
            originalContent[index] = {
                element: element,
                html: element.innerHTML
            };
        }

        // Aplica Bionic Reading
        const bionicText = convertToBionic(element.textContent);
        element.innerHTML = bionicText;
    });
}

function restoreOriginalText() {
    // Restaura o conte√∫do original
    Object.values(originalContent).forEach(item => {
        item.element.innerHTML = item.html;
    });
}

function convertToBionic(text) {
    // Divide o texto em palavras, mantendo pontua√ß√£o
    const words = text.split(/(\s+|[.,;:!?()""''\-‚Äì‚Äî])/);

    const bionicWords = words.map(word => {
        // Ignora espa√ßos e pontua√ß√£o
        if (word.match(/^\s+$/) || word.match(/^[.,;:!?()""''\-‚Äì‚Äî]+$/)) {
            return word;
        }

        // Ignora palavras muito curtas (1-2 letras)
        if (word.length <= 2) {
            return word;
        }

        // Determina quantas letras deixar em negrito (metade da palavra, arredondado para cima)
        const boldLength = Math.ceil(word.length / 2);

        // Separa a parte em negrito da parte normal
        const boldPart = word.substring(0, boldLength);
        const normalPart = word.substring(boldLength);

        // Retorna com a primeira parte em negrito
        return `<strong style="font-weight: 700 !important; color: inherit !important; background: none !important; padding: 0 !important;">${boldPart}</strong>${normalPart}`;
    });

    return bionicWords.join('');
}

// Adiciona atalho de teclado (Ctrl+B ou Cmd+B)
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        toggleBionicReading();
    }
});
</script>

<script>
    let highlighterActive = false;
    let questionHighlights = {};

    // Get question ID from the first summary strong tag
    function getQuestionId() {
        const firstSummary = document.querySelector('summary strong');
        return firstSummary ? firstSummary.textContent.trim() : '1';
    }

    // Load highlights from localStorage
    function loadHighlights() {
        const questionId = getQuestionId();
        const stored = localStorage.getItem('highlights_' + questionId);
        if (stored) {
            questionHighlights = JSON.parse(stored);
            applyStoredHighlights();
        }
    }

    // Save highlights to localStorage
    function saveHighlights() {
        const questionId = getQuestionId();
        localStorage.setItem('highlights_' + questionId, JSON.stringify(questionHighlights));
    }

    // Apply stored highlights
    function applyStoredHighlights() {
        Object.keys(questionHighlights).forEach(key => {
            const element = document.querySelector(`[data-highlight-id="${key}"]`);
            if (element && questionHighlights[key]) {
                element.classList.add('highlighted');
            }
        });
    }

    // Toggle highlighter mode
    function toggleHighlighter(event) {
        event.stopPropagation();
        highlighterActive = !highlighterActive;

        const btn = event.target.closest('.highlighter-btn');
        const icon = btn.querySelector('#highlighterIcon');

        if (highlighterActive) {
            btn.classList.add('active');
            icon.textContent = 'üñçÔ∏è';
            document.body.classList.add('highlighter-mode-active');
        } else {
            btn.classList.remove('active');
            icon.textContent = 'üñäÔ∏è';
            document.body.classList.remove('highlighter-mode-active');
        }
    }

    // Clear all highlights for this question
    function clearHighlights() {
        const questionId = getQuestionId();
        questionHighlights = {};
        localStorage.removeItem('highlights_' + questionId);
        document.querySelectorAll('.highlighted').forEach(el => {
            el.classList.remove('highlighted');
        });
    }

    // Handle text selection and highlighting
    document.addEventListener('mouseup', function(e) {
        if (!highlighterActive) return;

        const selection = window.getSelection();
        if (!selection.toString().trim()) return;

        const range = selection.getRangeAt(0);
        const container = range.commonAncestorContainer;

        // Only highlight text in paragraphs, not in buttons or other elements
        const paragraph = container.nodeType === 3 ? container.parentElement : container;
        if (paragraph.tagName !== 'P' && paragraph.tagName !== 'LI' && paragraph.tagName !== 'TD') {
            return;
        }

        // Create highlight span
        const span = document.createElement('span');
        span.classList.add('highlighted');

        // Generate unique ID for this highlight
        const highlightId = 'hl-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        span.setAttribute('data-highlight-id', highlightId);

        try {
            range.surroundContents(span);
            questionHighlights[highlightId] = true;
            saveHighlights();
        } catch (e) {
            console.log('Could not highlight selection');
        }

        selection.removeAllRanges();
    });

    // Load highlights when page loads
    window.addEventListener('load', loadHighlights);

    // Keyboard shortcut: Ctrl+H to toggle highlighter
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'h') {
            e.preventDefault();
            const btn = document.querySelector('.highlighter-btn');
            if (btn) {
                toggleHighlighter({target: btn, stopPropagation: () => {}});
            }
        }
        // Ctrl+Shift+H to clear all highlights
        if (e.ctrlKey && e.shiftKey && e.key === 'H') {
            e.preventDefault();
            if (confirm('Clear all highlights for this question?')) {
                clearHighlights();
            }
        }
    });
</script>
